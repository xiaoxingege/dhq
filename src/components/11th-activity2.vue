<style>
body {
    background-color: #000 !important;
    font-family: '微软雅黑';
}

input {
    outline: none;
}

.bg2 .lottery-box .inner_01>ul {
    width: 5.77rem;
    margin-top: 0;
}

.bg2 .lottery-box .inner_01>ul li {
    width: 1.86rem;
    height: 1.55rem;
    margin: 0 0.03rem 0.03rem 0.03rem;
    border-radius: 10px;
    background: none;
}
</style>
<style lang="scss" scoped>
@import '../assets/css/reset.css';
.box {
    width: 100%;
}
.bg1 {
    background: url("../assets/images/11th-activity2/11th2-bg1.jpg") center 0 no-repeat;
    height: 7.09rem;
    background-size: 100% 100%;
    position: relative;
}
.bg1.bg1-1 {
    background: url("../assets/images/11th-activity2/11th2-bg1-1.jpg") center 0 no-repeat;
    height: 7.09rem;
    background-size: 100% 100%;
    position: relative;
}
.bg1.bg1-2 {
    background: url("../assets/images/11th-activity2/11th2-bg1-1.jpg") center 0 no-repeat;
    height: 7.09rem;
    background-size: 100% 100%;
    position: relative;
}
.bg1.bg1-3 {
    background: url("../assets/images/11th-activity2/11th2-bg1-1.jpg") center 0 no-repeat;
    height: 7.09rem;
    background-size: 100% 100%;
    position: relative;
}
.bg2 {
    background: url("../assets/images/11th-activity2/11th2-bg2-2.jpg") center 0 no-repeat;
    height: 6.53rem;
    background-size: 100% 100%;
}
.bg3 {
    background: url("../assets/images/11th-activity2/11th2-bg3.jpg") center 0 no-repeat;
    height: 3.41rem;
    background-size: 100% 100%;
}
.bg4 {
    background: url("../assets/images/11th-activity2/11th2-bg4.jpg") center 0 no-repeat;
    height: 7.37rem;
    background-size: 100% 100%;
}
.box-con {
    position: relative;
    height: 100%;
}
.rotate_origin {
    transform-origin: 50% 50%;
    -ms-transform-origin: 50% 50%;
    -webkit-transform-origin: 50% 50%;
    -moz-transform-origin: 50% 50%;
    -o-transform-origin: 50% 50%;
}
.rotate_origin1 {
    transform-origin: 50% 85%;
    -ms-transform-origin: 50% 85%;
    -webkit-transform-origin: 50% 85%;
    -moz-transform-origin: 50% 85%;
    -o-transform-origin: 50% 85%;
}
.bg2 .box-con p {
    width: 100%;
    height: 0.48rem;
    line-height: 0.48rem;
    text-align: center;
    font-weight: bold;
    font-size: 0.34rem;
    color: #ff6547;
    float: left;
    margin-top: 0.65rem;
}
.bg2 .box-con p span {
    width: 0.59rem;
    height: 0.48rem;
    border: 0.01rem #ff6547 solid;
    display: inline-block;
    margin: 0 0.1rem;
}
.text-box {
    float: left;
    margin-left: 0.4rem;
    font-size: 0.26rem;
    color: #fef0cc;
}
.text-box div {
    line-height: 0.38rem;
    width: 5.80rem;
    height: 1.8rem;
    float: left;
    margin: 0.21rem 0 0 0.5rem;
    overflow: hidden;
}
.text-box div strong {
    text-align: center;
    display: block;
    width: 100%;
}
.text-box div p {
    font-size: 0.24rem;
}
.fixBg {
    width: 100%;
    height: 100%;
    position: fixed;
    top: 0;
    left: 0;
    background-color: #000;
    opacity: 0.8;
    z-index: 11;
}
.pop {
    width: 5.3rem;
    height: 4.37rem;
    background: url("../assets/images/11th-activity/11th-pop-bg.png") 0 0 no-repeat;
    background-size: 100% 100%;
    position: fixed;
    top: 50%;
    margin-top: -2.18rem;
    margin-left: -2.65rem;
    left: 50%;
    z-index: 12;
}
.lottery-msg1 {
    width: 100%;
    height: 100%;
    position: relative;
}
.lottery-msg1 strong {
    font-size: 0.46rem;
    font-weight: bold;
    color: #840135;
    text-align: center;
    float: left;
    width: 100%;
    margin-top: 0.6rem;
}
.lottery-msg1 p {
    float: left;
    width: 100%;
    margin-top: 0.2rem;
    text-align: center;
    font-size: 0.26rem;
    color: #840034;
    line-height: 0.4rem;
}
.lottery-msg1 a {
    position: absolute;
    bottom: 0.8rem;
    left: 1.65rem;
    width: 2.1rem;
    height: 0.56rem;
    background-color: #840034;
    color: #fff;
    font-size: 0.3rem;
    text-align: center;
    border-radius: 0.15rem;
    line-height: 0.56rem;
}
#divdown1 {
    position: absolute;
    color: white;
    width: 6rem;
    font-size: 0.34rem;
    bottom: 0.17rem;
    left: 1rem;
    font-family: Consolas, Monaco, monospace;
}
#divdown1 span {
    letter-spacing: 0.25rem;
    text-indent: 0.1rem;
    width: 1.1rem;
    overflow: hidden;
    display: inline-block;
    vertical-align: middle;
    float: left;
    margin-right: 0.36rem;
    line-height: 0.66rem;
}
#divdown1 .text-day {
    text-indent: 0.15rem;
}
#divdown1span:last-child {
    margin: 0;
}

.lottery-box {
    width: 100%;
    float: left;
    margin-top: 0.35rem;
}
.bg3 .box-con strong {
    width: 100%;
    float: left;
    height: 0.5rem;
    font-size: 0.3rem;
    color: #fef0cc;
    line-height: 0.5rem;
    text-align: center;
}
.bg3 .box-con p {
    font-size: 0.22rem;
    color: #fef0cc;
    width: 100%;
    float: left;
    height: 0.47rem;
    line-height: 0.47rem;
    text-align: center;
}
.vihi {
    visibility: hidden;
}
</style>

<template>
<div class="box">
    <div class="bg1">
        <div id="divdown1">
            <span id="text-day" class="text-day"></span>
            <span id="text-hour" class="text-hour"></span>
            <span id="text-min" class="text-min"></span>
            <span id="text-sec" class="text-sec"></span>
        </div>
    </div>
    <div class="bg2">
        <div class="box-con">
            <div class="lottery-box" ref="lotteryBox">
                <lottery @start="playLottery" @stop="showLotteryResult" :prize="prize" :box-width="lotteryBoxWidth" />
            </div>
            <p>您当前有<span v-text='remainCnt'></span>次抽奖机会</p>
        </div>
    </div>
    <div class="bg3">
        <div class="box-con">
            <strong v-text="loginMsg"></strong>
            <p :class="userId ? '':'vihi'">（您可以从中奖记录中任选1个进行兑奖）</p>
            <div class="text-box">
                <div class="text-scroll">
                    <ul>
                        <li v-for="item in whereList">{{item.userName}}抽中{{item.prizeName}}奖品</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="bg4">
    </div>


    <div class='fixBg' v-if="popShow"></div>
    <div class="pop" v-if="popShow">
        <div class="lottery-msg1">
            <strong v-text="lotteryTitle"></strong>
            <p v-html="lotteryMsg"></p>
            <a href="javascript:;" class="btn-close" @click="close">知道了</a>
        </div>
    </div>
</div>
</template>
<script>
import {
    mapState
} from 'vuex'
import jQuery from 'jquery'
window.jQuery = window.$ = jQuery
import lottery from 'components/lottery'
import getCookie from 'utils/getCookie'


export default {
    data() {
        $(function() {
            // 微信分享
            window.InitWeChatShare({
                shareTitle: window.document.title,
                shareLink: window.location.href,
                shareDesc: '双11疯狂送，11月6日-11月30日极智选股、Z量化等产品，免费来抢iPhoneX~',
                shareImg: 'http://i0.jrjimg.cn/zqt-red-1000/focus/Qcode/11th2-share-img.jpg',
                callback: function(wx) {}
            })
        })
        return {
            popShow: false,
            lotteryTitle: '',
            lotteryMsg: '',
            lotteryType: false,
            lotteryNum: '0',
            lotteryBoxWidth: 0,
            prize: 0,
            loginMsg: '',
            userId: '',
            paltid: ''
        }
    },
    computed: mapState({
        whereList: state => {
            return state.activity11Th.dataList
        },
        err: state => {
            return state.activity11Th.err
        },
        loginStatus: state => state.user.loginStatus,
        remainCnt: state => state.activity11Th.remainCnt,
        lotteryResult: state => state.activity11Th.lotteryResult,
        ssoId: state => state.user.ssoId
    }),
    components: {
        lottery
    },
    methods: {
        playLottery() {
            var ua = navigator.userAgent.toLowerCase();
            if (ua.match(/MicroMessenger/i) + '' === 'micromessenger') {
                alert('请在浏览器中打开')
            }
            if (typeof jrj !== 'undefined' && window.jrj.jsCallNative) {
                if (this.paltid === 'android') {
                    if (this.loginStatus === 'no' || this.loginStatus === 'unknown') {
                        window.jrj.jsCallNative('108', JSON.stringify({
                            returnUrl: encodeURI(window.location.href)
                        }))
                    } else {
                        this.$store.dispatch('activity11Th/lotteryDraw', {
                            userId: this.ssoId
                        }).then(() => {
                            this.$watch('err', err => {
                                if (err.retCode === -2) {
                                    this.popShow = true
                                    this.lotteryTitle = '抽奖还未开始'
                                    this.lotteryMsg = '抽奖通道将于2017年11月11日、<br />17日、24日、30日晚8:00准时开启。'
                                } else if (err.retCode === -3) {
                                    this.popShow = true
                                    this.lotteryTitle = '很遗憾'
                                    this.lotteryMsg = '您不满足本次活动抽奖条件，<br />您可以查看活动规则了解抽奖攻略。'
                                } else if (err.retCode === -4) {
                                    this.popShow = true
                                    this.lotteryTitle = '很遗憾'
                                    this.lotteryMsg = '您的抽奖次数已经用完了，<br />请在“我的可选奖品”中<br />选择兑换喜欢的奖品。'
                                } else if (err.retCode === -1 || err.retCode === -5) {
                                    alert(err.msg)
                                }
                            })
                            this.$watch('lotteryResult', lotteryResult => {
                                if (lotteryResult.prizeId === 1) {
                                    this.prize = 2
                                } else if (lotteryResult.prizeId === 2) {
                                    this.prize = 3
                                } else if (lotteryResult.prizeId === 3) {
                                    this.prize = 4
                                } else if (lotteryResult.prizeId === 4) {
                                    this.prize = 5
                                } else if (lotteryResult.prizeId === 5) {
                                    this.prize = 6
                                } else if (lotteryResult.prizeId === 6) {
                                    this.prize = 7
                                } else if (lotteryResult.prizeId === 7) {
                                    this.prize = 8
                                } else if (lotteryResult.prizeId === 8) {
                                    this.prize = 1
                                }
                                this.lotteryTitle = '恭喜您！'
                                this.lotteryMsg = '本次抽中了' + lotteryResult.prizeName + '<br />您可以在“我的可选奖品”中查看。'
                                this.remainCnt = this.remainCnt - 1
                            })
                        })
                    }
                } else {
                    if (!this.userId) {
                        window.jrj.jsCallNative('108', JSON.stringify({
                            returnUrl: encodeURI(window.location.href)
                        }))
                    } else {
                        this.$store.dispatch('activity11Th/lotteryDraw', {
                            userId: this.userId
                        }).then(() => {
                            this.$watch('err', err => {
                                if (err.retCode === -2) {
                                    this.popShow = true
                                    this.lotteryTitle = '抽奖还未开始'
                                    this.lotteryMsg = '抽奖通道将于2017年11月11日、<br />17日、24日、30日晚8:00准时开启。'
                                } else if (err.retCode === -3) {
                                    this.popShow = true
                                    this.lotteryTitle = '很遗憾'
                                    this.lotteryMsg = '您不满足本次活动抽奖条件，<br />您可以查看活动规则了解抽奖攻略。'
                                } else if (err.retCode === -4) {
                                    this.popShow = true
                                    this.lotteryTitle = '很遗憾'
                                    this.lotteryMsg = '您的抽奖次数已经用完了，<br />请在“我的可选奖品”中<br />选择兑换喜欢的奖品。'
                                } else if (err.retCode === -1 || err.retCode === -5) {
                                    alert(err.msg)
                                }
                            })
                            this.$watch('lotteryResult', lotteryResult => {
                                if (lotteryResult.prizeId === 1) {
                                    this.prize = 2
                                } else if (lotteryResult.prizeId === 2) {
                                    this.prize = 3
                                } else if (lotteryResult.prizeId === 3) {
                                    this.prize = 4
                                } else if (lotteryResult.prizeId === 4) {
                                    this.prize = 5
                                } else if (lotteryResult.prizeId === 5) {
                                    this.prize = 6
                                } else if (lotteryResult.prizeId === 6) {
                                    this.prize = 7
                                } else if (lotteryResult.prizeId === 7) {
                                    this.prize = 8
                                } else if (lotteryResult.prizeId === 8) {
                                    this.prize = 1
                                }
                                this.lotteryTitle = '恭喜您！'
                                this.lotteryMsg = '本次抽中了' + lotteryResult.prizeName + '<br />您可以在“我的可选奖品”中查看。'
                                this.remainCnt = this.remainCnt - 1
                            })
                        })
                    }
                }

            } else {
                window.location = 'jrjnews://tougu?t=web&url=http://itougu.jrj.com.cn/actm/11th-activity2'
            }
        },
        showLotteryResult() {
            this.popShow = true
            this.prize = -1
        },
        close() {
            window.location.reload(true)
            // window.location = 'http://itougu.jrj.com.cn/actm/11th-activity2?v' + Math.random()
            this.popShow = false
        }
    },
    mounted() {
        this.userId = getCookie('passportId')
        this.paltid = getCookie('paltid')

        function pad(str, len) {
            str = str + ''
            if (str.length < len) {
                for (let i = 0; i < len - str.length; i++) {
                    str = '0' + str
                }
            }
            return str
        }

        function ShowCountDown(year, month, day, hours, minutes, seconds, divname) {
            var now = new Date()
            var endDate = new Date(year, month - 1, day, hours, minutes, seconds)
            var leftTime = endDate.getTime() - now.getTime()
            var leftsecond = parseInt(leftTime / 1000)
            var day1 = Math.floor(leftsecond / (60 * 60 * 24))
            var hour = Math.floor((leftsecond - day1 * 24 * 60 * 60) / 3600)
            var minute = Math.floor((leftsecond - day1 * 24 * 60 * 60 - hour * 3600) / 60)
            var second = Math.floor(leftsecond - day1 * 24 * 60 * 60 - hour * 3600 - minute * 60)
            if (day1 < 0) {
                day1 = '00';
                hour = '00';
                minute = '00';
                second = '00';
            }
            document.getElementById('text-day').innerHTML = pad(day1, 2)
            document.getElementById('text-hour').innerHTML = pad(hour, 2)
            document.getElementById('text-min').innerHTML = pad(minute, 2)
            document.getElementById('text-sec').innerHTML = pad(second, 2)
        }

        function transdate(endTime) {
            var date = new Date();
            date.setFullYear(endTime.substring(0, 4));
            date.setMonth(endTime.substring(5, 7) - 1);
            date.setDate(endTime.substring(8, 10));
            date.setHours(endTime.substring(11, 13));
            date.setMinutes(endTime.substring(14, 16));
            date.setSeconds(endTime.substring(17, 19));
            return Date.parse(date) / 1000;
        }
        if (Math.round(new Date().getTime() / 1000) > transdate('2017-11-13 20:00:00') && Math.round(new Date().getTime() / 1000) < transdate('2017-11-19 20:00:00')) {
            console.log('1')
            $(".bg1").addClass('bg1-1')
            window.setInterval(function() {
                ShowCountDown(2017, 11, 17, 20, 0, 0)

            }, 1000)
        } else if (Math.round(new Date().getTime() / 1000) > transdate('2017-11-19 20:00:00') && Math.round(new Date().getTime() / 1000) < transdate('2017-11-26 20:00:00')) {
            console.log('2')
            $(".bg1").addClass('bg1-2')
            window.setInterval(function() {
                ShowCountDown(2017, 11, 24, 20, 0, 0)

            }, 1000)
        } else if (Math.round(new Date().getTime() / 1000) > transdate('2017-11-26 20:00:00')) {
            console.log('3')
            $(".bg1").addClass('bg1-3')
            window.setInterval(function() {
                ShowCountDown(2017, 11, 30, 20, 0, 0)

            }, 1000)
        } else {
            console.log('4')
            window.setInterval(function() {
                ShowCountDown(2017, 11, 11, 20, 0, 0)

            }, 1000)
        }
        if (this.paltid === 'android') {
            this.$store.dispatch('user/checkLogin').then(() => {
                this.$store.dispatch('activity11Th/whereList', {
                    userId: this.ssoId || ''
                })
            })
            if (this.loginStatus === 'no' || this.loginStatus === 'unknown') {
                this.loginMsg = '用户中奖纪录'
            } else {
                this.loginMsg = '我的可选奖品'
            }
        } else {
            this.$store.dispatch('user/checkLogin').then(() => {
                this.$store.dispatch('activity11Th/whereList', {
                    userId: this.userId || ''
                })
            })
            if (!this.userId) {
                this.loginMsg = '用户中奖纪录'
            } else {
                this.loginMsg = '我的可选奖品'
            }
        }
        this.$watch('whereList', whereList => {
            if (whereList.length > 5) {
                var liHeight = $('.text-scroll ul li').height()
                setInterval(function() {
                    $('.text-scroll ul').animate({
                        'margin-top': '-' + liHeight
                    }, 500, function() {
                        $('.text-scroll ul').append($('.text-scroll ul li:first'))
                        $('.text-scroll ul').css({
                            'margin-top': '0'
                        })
                    })
                }, 1000)
            }
        })
    }
}
</script>
