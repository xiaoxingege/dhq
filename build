#!/bin/bash

export BUILD_ID=dontKillMePlease

uname=`uname`
user=`whoami`

echo $user

function p() {
  if [ "$user" = "jenkins" ]; then
    echo $1
  else
    echo -e "\033[32m$1\033[0m"
  fi
}

function perr() {
  if [ "$user" = "jenkins" ]; then
    echo $1
  else
    echo -e "\033[31m$1\033[0m"
  fi
}

function pwarn() {
  if [ "$user" = "jenkins" ]; then
    echo $1
  else
    echo -e "\033[33m$1\033[0m"
  fi
}

function pinfo() {
  if [ "$user" = "jenkins" ]; then
    echo $1
  else
    echo -e "\033[36m$1\033[0m"
  fi
}

function get_port() {
  is_use="0"
  if [ "$uname" = "Linux" ];then
    is_use=`netstat -nltp | grep ':'$port' ' | wc -l`
  else
    is_use=`sudo lsof -P -itcp:$port | grep ':'$port' (LISTEN)' | wc -l`
  fi
  while [ $is_use = "1" ]
  do
    let "port+=1"
    if [ "$uname" = "Linux" ];then
      is_use=`netstat -nltp | grep ':'$port' ' | wc -l`
    else
      is_use=`sudo lsof -P -itcp:$port | grep ':'$port' (LISTEN)' | wc -l`
    fi
  done
}

port=3000

errstr="__error__"


version=$(cat package.json | grep -oE '"version":.*' | awk -F '"' '{print $4}')
echo version=$(echo $version) > /tmp/$feature.profile
pinfo 'current version: '$version

yarn config set registry https://registry.npm.taobao.org
code="1"
while [ "$code" != "0" ]
do
  yarn install
  code=$?
  if [ "$code" != "0" ]; then
    pinfo 'retry install modules...'
    rm -rf node_modules
    sleep 5s
  fi
done
pinfo 'yarn install done.'

# rm -rf dist/$feature/*.*
# rm -rf dist/$feature/ftp
export JRJ_FEATURE=$feature
# npm run build -- --env=$feature
if [ "$?" != "0" ]; then
  exit 1
fi
pinfo 'npm build done.'
# npm run buildserver
if [ "$?" != "0" ]; then
  exit 1
fi
pinfo 'npm buildserver done.'
pinfo 'checking for new files'
newfiles=()
ftp -n 117.121.12.155 <<f1 >>/dev/null
quote USER shihuang.piao.ftp.img
quote PASS n6i7&FOy^q
mkdir jrjimg/assets/$feature
mkdir jrjimg/assets/$feature/images
bye
f1

# for file in $(ls dist/$feature/*)
# do
#   if [ -f $file ]; then
#     filename=${file##*/}
#     status=$(curl -I -w %{http_code} -o /dev/null -s "http://i0.jrjimg.cn/assets/$feature/$filename")
#     if [ $status = 404 ]; then
#       pinfo "$filename transfered"
#       newfiles[${#newfiles[@]}]=$file
#       mkdir -p dist/$feature/ftp/
#       cp $file dist/$feature/ftp/
#     fi
#   fi
# done
#
# if [ -d dist/$feature/images ]; then
#   for file in $(ls dist/$feature/images/*)
#   do
#     if [ -f $file ]; then
#       filename=${file##*/}
#       status=$(curl -I -w %{http_code} -o /dev/null -s "http://i0.jrjimg.cn/assets/$feature/images/$filename")
#       if [ $status = 404 ]; then
#         pinfo "$filename transfered"
#         mkdir -p dist/$feature/ftp/images/
#         cp $file dist/$feature/ftp/images/
#       fi
#     fi
#   done
# fi

if [ ${#newfiles[@]} -gt 0 ]; then
  pinfo 'has new files.'
  ftp -n 117.121.12.155 <<f2 >>/dev/null
quote USER shihuang.piao.ftp.img
quote PASS n6i7&FOy^q
prompt
cd jrjimg/assets/$feature/
lcd dist/$feature/ftp/
mput *
bye
f2
  if [ -d dist/$feature/ftp/images ]; then
    ftp -n 117.121.12.155 <<f3 >>/dev/null
quote USER shihuang.piao.ftp.img
quote PASS n6i7&FOy^q
prompt
cd jrjimg/assets/$feature/images/
lcd dist/$feature/ftp/images/
mput *
bye
f3
  fi
  for file in ${newfiles[*]}
  do
    if [ -f $file ]; then
      filename=${file##*/}
      status="404"
      pinfo "waiting for $filename"
      while [ "$status" != "200" ]
      do
        status=$(curl -I -w %{http_code} -o /dev/null -s "http://i0.jrjimg.cn/assets/$feature/$filename")
        wait
        if [ "$status" != "200" ]; then
          sleep 5s
        fi
      done
    fi
  done
fi

if [ "$feature" != "z3tougu" ]; then
get_port
pinfo 'using port: '$port
pm2name=$feature"_"$branch
pinfo 'pm2 name: '$pm2name
ssh admin@127.0.0.1 -p 62222 'mkdir -p /home/admin/code/'$feature
ssh admin@127.0.0.1 -p 62222 'rm -rf /home/admin/code/'$feature'/*'
scp -r -P 62222 * admin@127.0.0.1:/home/admin/code/$feature/
ssh -t -t admin@127.0.0.1 -p 62222 <<ssh
sudo pm2 list | sudo grep '^│ '$pm2name | sudo wc -l
if [ "`sudo pm2 list | sudo grep '^│ '$pm2name | sudo wc -l`" == "1" ]; then
  sudo pm2 reload $pm2name
else
  echo 'start pm2'
  cd /home/admin/code/$feature
  sudo pm2 start -n $pm2name dist/$feature/server/index.js -- $port
  sudo pm2 save
fi
exit
ssh
fi
